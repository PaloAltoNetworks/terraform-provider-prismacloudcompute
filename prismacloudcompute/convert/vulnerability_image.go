package convert

import (
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
	"github.com/paloaltonetworks/prisma-cloud-compute-go/policy"
)

func SchemaToVulnerabilityImageRules(d *schema.ResourceData) ([]policy.VulnerabilityImageRule, error) {
	parsedRules := make([]policy.VulnerabilityImageRule, 0)
	if rules, ok := d.GetOk("rule"); ok {
		presentRules := rules.([]interface{})
		for _, val := range presentRules {
			presentRule := val.(map[string]interface{})
			parsedRule := policy.VulnerabilityImageRule{}

			if presentRule["alert_threshold"].([]interface{})[0] != nil {
				presentAlertThreshold := presentRule["alert_threshold"].([]interface{})[0].(map[string]interface{})
				parsedRule.AlertThreshold = policy.VulnerabilityImageThreshold{
					Disabled: presentAlertThreshold["disabled"].(bool),
					Value:    presentAlertThreshold["value"].(int),
				}
			} else {
				parsedRule.AlertThreshold = policy.VulnerabilityImageThreshold{}
			}

			parsedRule.BlockMessage = presentRule["block_message"].(string)

			if presentRule["block_threshold"].([]interface{})[0] != nil {
				presentBlockThreshold := presentRule["block_threshold"].([]interface{})[0].(map[string]interface{})
				parsedRule.BlockThreshold = policy.VulnerabilityImageThreshold{
					Enabled: presentBlockThreshold["enabled"].(bool),
					Value:   presentBlockThreshold["value"].(int),
				}
			} else {
				parsedRule.BlockThreshold = policy.VulnerabilityImageThreshold{}
			}

			parsedRule.Collections = PolicySchemaToCollections(presentRule["collections"].([]interface{}))

			presentCveRules := presentRule["cve_rule"].([]interface{})
			parsedCveRules := make([]policy.VulnerabilityImageCveRule, 0, len(presentCveRules))
			for _, val := range presentCveRules {
				presentCveRule := val.(map[string]interface{})
				parsedCveRules = append(parsedCveRules, policy.VulnerabilityImageCveRule{
					Description: presentCveRule["description"].(string),
					Effect:      presentCveRule["effect"].(string),
					Expiration:  schemaToVulnerabilityImageExpiration(presentCveRule["expiration"].([]interface{})),
					Id:          presentCveRule["id"].(string),
				})
			}
			parsedRule.CveRules = parsedCveRules

			parsedRule.Disabled = presentRule["disabled"].(bool)
			parsedRule.Effect = presentRule["effect"].(string)
			parsedRule.GraceDays = presentRule["grace_days"].(int)
			parsedRule.Name = presentRule["name"].(string)
			parsedRule.Notes = presentRule["notes"].(string)
			parsedRule.OnlyFixed = presentRule["only_fixed"].(bool)

			presentTagRules := presentRule["tag_rule"].([]interface{})
			parsedTagRules := make([]policy.VulnerabilityImageTagRule, 0, len(presentTagRules))
			for _, val := range presentTagRules {
				presentTagRule := val.(map[string]interface{})
				parsedTagRules = append(parsedTagRules, policy.VulnerabilityImageTagRule{
					Description: presentTagRule["description"].(string),
					Effect:      presentTagRule["effect"].(string),
					Expiration:  schemaToVulnerabilityImageExpiration(presentTagRule["expiration"].([]interface{})),
					Name:        presentTagRule["name"].(string),
				})
			}
			parsedRule.TagRules = parsedTagRules

			parsedRule.Verbose = presentRule["verbose"].(bool)

			parsedRules = append(parsedRules, parsedRule)
		}
	}
	return parsedRules, nil
}

func schemaToVulnerabilityImageExpiration(in []interface{}) policy.VulnerabilityImageExpiration {
	parsedExpiration := policy.VulnerabilityImageExpiration{}
	if in[0] == nil {
		return parsedExpiration
	}
	presentExpiration := in[0].(map[string]interface{})
	parsedExpiration.Date = presentExpiration["date"].(string)
	parsedExpiration.Enabled = presentExpiration["enabled"].(bool)
	return parsedExpiration
}

func VulnerabilityImageRulesToSchema(in []policy.VulnerabilityImageRule) []interface{} {
	ans := make([]interface{}, 0, len(in))
	for _, val := range in {
		m := make(map[string]interface{})
		m["alert_threshold"] = vulnerabilityImageAlertThresholdToSchema(val.AlertThreshold)
		m["block_message"] = val.BlockMessage
		m["block_threshold"] = vulnerabilityImageBlockThresholdToSchema(val.BlockThreshold)
		m["collections"] = CollectionsToPolicySchema(val.Collections)
		m["cve_rule"] = vulnerabilityImageCveRulesToSchema(val.CveRules)
		m["disabled"] = val.Disabled
		m["effect"] = val.Effect
		m["grace_days"] = val.GraceDays
		m["name"] = val.Name
		m["notes"] = val.Notes
		m["only_fixed"] = val.OnlyFixed
		m["tag_rule"] = vulnerabilityImageTagRulesToSchema(val.TagRules)
		m["verbose"] = val.Verbose
		ans = append(ans, m)
	}
	return ans
}

func vulnerabilityImageAlertThresholdToSchema(in policy.VulnerabilityImageThreshold) []interface{} {
	ans := make([]interface{}, 0, 1)
	m := make(map[string]interface{})
	m["disabled"] = in.Disabled
	m["value"] = in.Value
	ans = append(ans, m)
	return ans
}

func vulnerabilityImageBlockThresholdToSchema(in policy.VulnerabilityImageThreshold) []interface{} {
	ans := make([]interface{}, 0, 1)
	m := make(map[string]interface{})
	m["enabled"] = in.Enabled
	m["value"] = in.Value
	ans = append(ans, m)
	return ans
}

func vulnerabilityImageCveRulesToSchema(in []policy.VulnerabilityImageCveRule) []interface{} {
	ans := make([]interface{}, 0, len(in))
	for _, val := range in {
		m := make(map[string]interface{})
		m["description"] = val.Description
		m["effect"] = val.Effect
		m["expiration"] = vulnerabilityImageExpirationToSchema(val.Expiration)
		m["id"] = val.Id
		ans = append(ans, m)
	}
	return ans
}

func vulnerabilityImageExpirationToSchema(in policy.VulnerabilityImageExpiration) []interface{} {
	ans := make([]interface{}, 0, 1)
	m := make(map[string]interface{})
	m["date"] = in.Date
	m["enabled"] = in.Enabled
	ans = append(ans, m)
	return ans
}

func vulnerabilityImageTagRulesToSchema(in []policy.VulnerabilityImageTagRule) []interface{} {
	ans := make([]interface{}, 0, len(in))
	for _, val := range in {
		m := make(map[string]interface{})
		m["description"] = val.Description
		m["effect"] = val.Effect
		m["expiration"] = vulnerabilityImageExpirationToSchema(val.Expiration)
		m["name"] = val.Name
		ans = append(ans, m)
	}
	return ans
}
