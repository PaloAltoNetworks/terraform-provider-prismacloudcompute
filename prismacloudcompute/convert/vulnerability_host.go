package convert

import (
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
	"github.com/paloaltonetworks/prisma-cloud-compute-go/policy"
)

func SchemaToVulnerabilityHostRules(d *schema.ResourceData) ([]policy.VulnerabilityHostRule, error) {
	parsedRules := make([]policy.VulnerabilityHostRule, 0)
	if rules, ok := d.GetOk("rule"); ok {
		presentRules := rules.([]interface{})
		for _, val := range presentRules {
			presentRule := val.(map[string]interface{})
			parsedRule := policy.VulnerabilityHostRule{}

			if presentRule["alert_threshold"].([]interface{})[0] != nil {
				presentAlertThreshold := presentRule["alert_threshold"].([]interface{})[0].(map[string]interface{})
				parsedRule.AlertThreshold = policy.VulnerabilityHostThreshold{
					Disabled: presentAlertThreshold["disabled"].(bool),
					Value:    presentAlertThreshold["value"].(int),
				}
			} else {
				parsedRule.AlertThreshold = policy.VulnerabilityHostThreshold{}
			}

			parsedRule.Collections = PolicySchemaToCollections(presentRule["collections"].([]interface{}))

			presentCveRules := presentRule["cve_rule"].([]interface{})
			parsedCveRules := make([]policy.VulnerabilityHostCveRule, 0, len(presentCveRules))
			for _, val := range presentCveRules {
				presentCveRule := val.(map[string]interface{})
				parsedCveRules = append(parsedCveRules, policy.VulnerabilityHostCveRule{
					Description: presentCveRule["description"].(string),
					Effect:      presentCveRule["effect"].(string),
					Expiration:  schemaToVulnerabilityHostExpiration(presentCveRule["expiration"].([]interface{})),
					Id:          presentCveRule["id"].(string),
				})
			}
			parsedRule.CveRules = parsedCveRules

			parsedRule.Disabled = presentRule["disabled"].(bool)
			parsedRule.Effect = presentRule["effect"].(string)
			parsedRule.GraceDays = presentRule["grace_days"].(int)
			parsedRule.Name = presentRule["name"].(string)
			parsedRule.Notes = presentRule["notes"].(string)
			parsedRule.OnlyFixed = presentRule["only_fixed"].(bool)

			presentTagRules := presentRule["tag_rule"].([]interface{})
			parsedTagRules := make([]policy.VulnerabilityHostTagRule, 0, len(presentTagRules))
			for _, val := range presentTagRules {
				presentTagRule := val.(map[string]interface{})
				parsedTagRules = append(parsedTagRules, policy.VulnerabilityHostTagRule{
					Description: presentTagRule["description"].(string),
					Effect:      presentTagRule["effect"].(string),
					Expiration:  schemaToVulnerabilityHostExpiration(presentTagRule["expiration"].([]interface{})),
					Name:        presentTagRule["name"].(string),
				})
			}
			parsedRule.TagRules = parsedTagRules

			parsedRules = append(parsedRules, parsedRule)
		}
	}
	return parsedRules, nil
}

func schemaToVulnerabilityHostExpiration(in []interface{}) policy.VulnerabilityHostExpiration {
	parsedExpiration := policy.VulnerabilityHostExpiration{}
	if in[0] == nil {
		return parsedExpiration
	}
	presentExpiration := in[0].(map[string]interface{})
	parsedExpiration.Date = presentExpiration["date"].(string)
	parsedExpiration.Enabled = presentExpiration["enabled"].(bool)
	return parsedExpiration
}

func VulnerabilityHostRulesToSchema(in []policy.VulnerabilityHostRule) []interface{} {
	ans := make([]interface{}, 0, len(in))
	for _, val := range in {
		m := make(map[string]interface{})
		m["alert_threshold"] = vulnerabilityHostAlertThresholdToSchema(val.AlertThreshold)
		m["collections"] = CollectionsToPolicySchema(val.Collections)
		m["cve_rule"] = vulnerabilityHostCveRulesToSchema(val.CveRules)
		m["disabled"] = val.Disabled
		m["effect"] = val.Effect
		m["grace_days"] = val.GraceDays
		m["name"] = val.Name
		m["notes"] = val.Notes
		m["only_fixed"] = val.OnlyFixed
		m["tag_rule"] = vulnerabilityHostTagRulesToSchema(val.TagRules)
		ans = append(ans, m)
	}
	return ans
}

func vulnerabilityHostAlertThresholdToSchema(in policy.VulnerabilityHostThreshold) []interface{} {
	ans := make([]interface{}, 0, 1)
	m := make(map[string]interface{})
	m["disabled"] = in.Disabled
	m["value"] = in.Value
	ans = append(ans, m)
	return ans
}

func vulnerabilityHostCveRulesToSchema(in []policy.VulnerabilityHostCveRule) []interface{} {
	ans := make([]interface{}, 0, len(in))
	for _, val := range in {
		m := make(map[string]interface{})
		m["description"] = val.Description
		m["effect"] = val.Effect
		m["expiration"] = vulnerabilityHostExpirationToSchema(val.Expiration)
		m["id"] = val.Id
		ans = append(ans, m)
	}
	return ans
}

func vulnerabilityHostExpirationToSchema(in policy.VulnerabilityHostExpiration) []interface{} {
	ans := make([]interface{}, 0, 1)
	m := make(map[string]interface{})
	m["date"] = in.Date
	m["enabled"] = in.Enabled
	ans = append(ans, m)
	return ans
}

func vulnerabilityHostTagRulesToSchema(in []policy.VulnerabilityHostTagRule) []interface{} {
	ans := make([]interface{}, 0, len(in))
	for _, val := range in {
		m := make(map[string]interface{})
		m["description"] = val.Description
		m["effect"] = val.Effect
		m["expiration"] = vulnerabilityHostExpirationToSchema(val.Expiration)
		m["name"] = val.Name
		ans = append(ans, m)
	}
	return ans
}
